<!DOCTYPE html>
<html>
	<title>Xdcheckin</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="initial-scale=0.4, user-scalable=no">
	<link rel="shortcut icon" href="#"/>
	<link rel="stylesheet" href="https://g.alicdn.com/apsara-media-box/imp-web-player/2.18.1/skins/default/aliplayer-min.css" />
	<script type="text/javascript" src="https://g.alicdn.com/apsara-media-box/imp-web-player/2.18.1/aliplayer-min.js"></script>
	<script type="text/javascript" src="static/classrooms.js"></script>
	<script type="text/javascript" src="https://xdcheckin.git.pnxlr.eu.org/src/backend/static/classrooms.js"></script>
	<script type="text/javascript" src="xdcheckin/get/locations.js"></script>

	<head>
		<style>
			div {font-size:22px; font-family: sans-serif;}
			.div-center {width: 100%; display: flex; justify-content: center; align-items: center;}
			button {height: 40px; font-size: 22px; user-select: none;}
			table, th, td {border: 1px solid black; border-collapse: collapse; text-align: center;}
			table {width: 100%;}
		</style>
	</head>

	<body id="main-body" style="display: block; padding: 0; margin: 0;">
		<div id="xdcheckin-update-div" style="text-align: center; font-weight: bold; display: none;"></div>
		<div id="xdcheckin-update-body-div" style="text-align: center; display: none;"></div>

		<div id="chaoxing-buttons" class="div-center">
			<button id="chaoxing-login-button" onclick="chaoxingLogin()">Chaoxing Login</button>
			<button id="chaoxing-curriculum-button" onclick="listDiv('curriculum-list-div')" style="display: none">Show Curriculum</button>
			<button id="chaoxing-locations-button" onclick="listDiv('locations-list-div')" style="display: none">Select Location</button>
			<button id="chaoxing-input-location-button" onclick="inputLocation()" style="display: none">Input Location</button>
			<button id="chaoxing-activities-button" onclick="listActivity()" style="display: none">Check Activities</button>
		</div>
		<div id="curriculum-list-div" style="display: none"></div>
		<div id="locations-list-div" style="display: none"></div>
		<div id="activities-list-div" style="display: none"></div>

		<div id="classrooms-buttons-div" class="div-center" style="display: none;">
			<button onclick="listDiv('classrooms-list-div')">Select Classroom</button>
			<button onclick="reloadClassroom(...randClassroom())">I'm Feeling Lucky</button>
			<button onclick="loadExtracted()">Load URL</button>
			<button id="extract-classroom-button" onclick="extractClassroom()" style="display: none;">Extract URL</button>
		</div>
		<div id="classrooms-list-div" style="display: none;"></div>

		<div id="xdcheckin-title-div" class="div-center" style="display: none; font-size:48px; font-family: sans-serif; font-weight: bold;">Xdcheckin</div>
		<div id="players-buttons-div" class="div-center" style="display: none;">
			<button onclick="player0.initPlay(); player1.initPlay(); player2.initPlay(); player3.initPlay();">Play All</button>
			<button onclick="player0.stop(); player1.stop(); player2.stop(); player3.stop();">Stop All</button>
			<button onclick="player0.unmute(); player1.unmute(); player2.unmute(); player3.unmute();">Unmute All</button>
			<button onclick="player0.mute(); player1.mute(); player2.mute(); player3.mute();">Mute All</button>
			<button onclick="resize()">Resize All</button>
		</div>

		<div id="player0-buttons-div" class="div-center" style="display: none;">
			<B style="font-size:40px; font-family: sans-serif;">PPTVideo</B>
			&emsp;
			<button onclick="player0.initPlay();">Play</button>
			<button onclick="player0.stop();">Stop</button>
			<button onclick="player0.unmute();">Unmute</button>
			<button onclick="player0.mute();;">Mute</button>
			<button id="player0-scan-button" onclick="chaoxingCheckinQrcode(); onclickCooldown(this.id);" style="display: none;">Scan</button>
		</div>
		<div id="player0-div"></div>
		<div id="player0-decodeddata-div" style="text-align: center; word-wrap: break-word; width: 400px;"></div>

		<div id="player1-buttons-div" class="div-center" style="display: none;">
			<B style="font-size:40px; font-family: sans-serif;">TeacherTrack</B>
			&emsp;
			<button onclick="player1.initPlay();">Play</button>
			<button onclick="player1.stop();">Stop</button>
			<button onclick="player1.unmute();">Unmute</button>
			<button onclick="player1.mute();;">Mute</button>
		</div>
		<div id="player1-div"></div>

		<div id="player2-buttons-div" class="div-center" style="display: none;">
			<B style="font-size:40px; font-family: sans-serif;">TeacherFull</B>
			&emsp;
			<button onclick="player2.initPlay();">Play</button>
			<button onclick="player2.stop();">Stop</button>
			<button onclick="player2.unmute();">Unmute</button>
			<button onclick="player2.mute();">Mute</button>
		</div>
		<div id="player2-div"></div>

		<div id="player3-buttons-div" class="div-center" style="display: none;">
			<B style="font-size:40px; font-family: sans-serif;">StudentFull</B>
			&emsp;
			<button onclick="player3.initPlay();">Play</button>
			<button onclick="player3.stop();">Stop</button>
			<button onclick="player3.unmute();">Unmute</button>
			<button onclick="player3.mute();">Mute</button>
		</div>
		<div id="player3-div"></div>

		<div id="footer-div" class="div-center">
			(C) 2024 Pairman&emsp;
			<a href="https://github.com/Pairman/Xdcheckin">Source Code</a>
		</div>
	</body>

	<script>
		/*
	 	 * Script.
		 */

		/* Check EULA state. */
		if (!localStorage.getItem("xdcheckin_eula"))
			if (confirm("This APP provides utilities for Chaoxing check-ins and classroom livestreams exclusively for XDUers.\n\n" +
				    "By confirming you agree to the following terms:\n" +
				    "    1. This APP is for study use only.\n" +
				    "    2. This work comes with absolutely no warranty.\n\n" +
				    "You have been warned.")) {
				localStorage.setItem("xdcheckin_eula", "1");
				document.getElementById("main-body").style.display = "block";
			}
		else
			document.getElementById("main-body").style.display = "block";

		/* Check APP updates. */
		var xdcheckin_version = "0.0.0";
		var xdcheckin_latest_release = {};
		var xdcheckin_update_available = false;
		post("/xdcheckin/get/version").then((res) => {
			assert(xdcheckin_version = res.text);
			post("/xdcheckin/get/releases/latest").then((res) => {
				assert(Object.keys(xdcheckin_latest_release = res.json()).length);
				let xdcheckin_version_arr = xdcheckin_version.split(".");
				let xdcheckin_latest_release_version_arr = xdcheckin_latest_release["tag_name"].split(".");
				for (let i = 0; i < 3; ++i) {
					if (parseInt(xdcheckin_version_arr[i]) > parseInt(xdcheckin_latest_release_version_arr[i]))
						break;
					if (parseInt(xdcheckin_version_arr[i]) < parseInt(xdcheckin_latest_release_version_arr[i]))
						xdcheckin_update_available = true;
				}
				if (xdcheckin_update_available) {
					let e = document.getElementById("xdcheckin-update-div");
					e.innerHTML = "<a href=\"" + xdcheckin_latest_release["html_url"] + "\">New APP version available!<br>Download " + xdcheckin_latest_release["tag_name"] + " here.</a>";
					e.style.display = "block";
					e = document.getElementById("xdcheckin-update-body-div");
					e.innerText = xdcheckin_latest_release["body"];
					e.style.display = "block";
				}
			}).catch((err) => {});
		}).catch((err) => {});

		/* Chaoxing login related. */
		var courses = {};
		var curriculum = {};
		var location_str = localStorage.getItem("location_");
		var location_ = (!location_str) ? locations["Bæ¥¼"] : JSON.parse(location_str);

		/* Players related. */
		/* Calculate video player dimensions. */
		var strWidth = "", strHeight = "";
		calculatePlayerSize();
		document.getElementById("player0-decodeddata-div").style.width = strWidth;

		/* Generate clasroom buttons list. */
		var buildingsArr = [], buildingNamesArr = [];
		const classrooms_list_div = document.getElementById("classrooms-list-div");
		for (let buildingName in urls) {
			let building = urls[buildingName];
			let div = document.createElement("div");
			div.innerText = buildingName + ": ";
			classrooms_list_div.appendChild(div);
			let classroomArr = [], classroomNamesArr = [];
			for (let classroomName in building) {
				let classroom = building[classroomName];
				classroomArr.push(classroom);
				classroomNamesArr.push(classroomName);
				let button = document.createElement("button");
				button.innerText = classroomName;
				button.setAttribute('onclick', 'reloadClassroom(\"' + classroom + '\", \"' + classroomName + '\")');
				classrooms_list_div.appendChild(button);
			}
			buildingsArr.push(classroomArr);
			buildingNamesArr.push(classroomNamesArr);
		}

		/* Initialize classroom name and urls. */
		var classroomName = localStorage.getItem("classroomName");
		var classroom = localStorage.getItem("classroom");
		var pptVideo, teacherTrack, teacherFull, studentFull;
		if (!classroom || !classroomName)
			[classroom, classroomName] = randClassroom();
		setClassroom(classroom, classroomName);

		/* Generate location buttons list. */
		const locations_list_div = document.getElementById("locations-list-div");
		for (let buildingName in locations) {
			let button = document.createElement("button");
			button.innerText = buildingName;
			button.setAttribute("onclick", "location_ = " + JSON.stringify(locations[buildingName]));
			locations_list_div.appendChild(button);
		}

		var player0 = undefined, player1 = undefined, player2 = undefined, player3 = undefined;
		enablePlayers();

		/*
		 * Function definitions.
		 */

		/* Enable players for XDUers. */
		function enablePlayers() {
			/* Classroom livestreams for XDUers only. */
			if (enablePlayers.done || enablePlayers.calling || !(localStorage.getItem("chaoxing_fid") == "16820"))
				return;
			enablePlayers.calling = true;
			document.getElementById("classrooms-buttons-div").style.display = "flex";
			document.getElementById("xdcheckin-title-div").style.display = "flex";
			document.getElementById("players-buttons-div").style.display = "flex";
			document.getElementById("player0-buttons-div").style.display = "flex";
			document.getElementById("player1-buttons-div").style.display = "flex";
			document.getElementById("player2-buttons-div").style.display = "flex";
			document.getElementById("player3-buttons-div").style.display = "flex";
			/* Create video players. */
			player0 = new Aliplayer({
				id: "player0-div",
				isLive: true,
				useH5Prism: true,
				width: strWidth,
				height: strHeight,
				autoplay: true,
				playsinline: true,
				source: pptVideo
			}, function(player0) {
				player0.mute();
				player0.play();
				player0.on("canplay", function () {
					let t = player0.getCurrentTime();
					if (player1.getStatus() == "playing")
						player1.seek(t);
					if (player2.getStatus() == "playing")
						player2.seek(t);
					if (player3.getStatus() == "playing")
						player3.seek(t);
				})
			});
			player1 = new Aliplayer({
				id: "player1-div",
				isLive: true,
				useH5Prism: true,
				width: strWidth,
				height: strHeight,
				playsinline: true,
				source: teacherTrack
			}, function(player1) {
				player1.mute();
				player1.stop();
			});
			player2 = new Aliplayer({
				id: "player2-div",
				isLive: true,
				useH5Prism: true,
				width: strWidth,
				height: strHeight,
				playsinline: true,
				source: teacherFull
			}, function (player2) {
				player2.mute();
				player2.stop();
			});
			player3 = new Aliplayer({
				id: "player3-div",
				isLive: true,
				useH5Prism: true,
				width: strWidth,
				height: strHeight,
				playsinline: true,
				source: studentFull
			}, function(player3) {
				player3.mute();
				player3.stop();
			});
			enablePlayers.done = true;
			enablePlayers.calling = false;
		}

		/* Assertion. */
		function assert(condition, message) {
			if (!condition)
				throw new Error(message || "Assertion failed");
		}

		/* Player size controls. */
		function getScrollBarWidth() {
			let e = document.createElement("div");
			e.style.cssText = "overflow:scroll; visibility:hidden; position:absolute;";
			document.body.appendChild(e);
			let w = e.offsetWidth - e.clientWidth;
			e.remove();
			return w;
		}

		function calculatePlayerSize(){
			let w = (window.innerWidth - getScrollBarWidth());
			let h = parseInt(w / 16 * 9);
			strWidth = w.toString() + "px";
			strHeight = h.toString() + "px";
		}

		function resize() {
			calculatePlayerSize();
			document.getElementById("player0-decodeddata-div").style.width = strWidth;
			player0.setPlayerSize(strWidth, strHeight);
			player1.setPlayerSize(strWidth, strHeight);
			player2.setPlayerSize(strWidth, strHeight);
			player3.setPlayerSize(strWidth, strHeight);
		}

		/* Div listing toggle. */
		function listDiv(e_id) {
			let e = document.getElementById(e_id);
			e.style.display = ((e.style.display == "none") ? "block" : "none");
		}

		/* Onclick cooldown. */
		function onclickCooldown(e_id, time = 1000) {
			let e = document.getElementById(e_id);
			e.style.pointerEvents = "none";
			setTimeout(function() {
				e.style.pointerEvents = "auto";
			}, time);
		};

		function tablifyCurriculum() {
			let table = document.createElement("table");
			table.border = "1";
			let tableBody = document.createElement("tbody");
			for (let class_id in curriculum) {
				let course = curriculum[class_id];
					let tr = document.createElement("tr");
				let td = document.createElement("td");
				td.appendChild(document.createTextNode(course["name"]));
				tr.appendChild(td);
				td = document.createElement("td");
				for (i in course["teacher"]) {
					td.appendChild(document.createTextNode(course["teacher"][i] + " "));
				}
				tr.appendChild(td);
				td = document.createElement("td");
				td.appendChild(document.createTextNode(course["location"]));
				tr.appendChild(td);
				tableBody.appendChild(tr);
			}
			table.appendChild(tableBody);
			document.getElementById("curriculum-list-div").appendChild(table);
		}

		/* Input location. */
		function inputLocation() {
			try {
				let latitude = prompt("Input latitude (maximum 6 float digits):");
				if (latitude === null)
					return;
				assert(latitude !== "" || !isNaN(latitude));
				let longitude = prompt("Input longitude (maximum 6 float digits):");
				if (longitude === null)
					return;
				assert(longitude !== "" || !isNaN(longitude));
				let address = prompt("Input address:");
				if (address === null)
					return;
				assert(address !== "" || !(/[`!@#$%^&*_+\=\[\]{};':"\\|,.<>\/?~]/.test(address)));
				location_ = {"latitude": latitude, "longitude": longitude, "address": address};
				localStorage.setItem("location_", JSON.stringify(location_));
			}
			catch (err) {
				alert("Invalid input.");
			}
		}

		/* Activities list toggle. */
		async function listActivity() {
			if (listActivity.calling)
				return;
			listActivity.calling = true;
			let e = document.getElementById("activities-list-div");
			if (e.style.display == "none") {
				e.innerText = "Loading activities.";
				e.style.display = "block";
				let activities = (await post("/chaoxing/get_activities")).json();
				e.replaceChildren();
				for (let class_id in activities) {
					let class_activities = activities[class_id];
					let div = document.createElement("div");
					div.innerText = courses[class_id]["name"] + ": ";
					e.appendChild(div);
					for (let i in class_activities) {
						let activity = class_activities[i];
						let button = document.createElement("button");
						button.id = "chaoxing-activity-" + activity["active_id"] + "-button";
						if (activity["type"] == "2")
							button.setAttribute("disabled", "");
						else
							button.setAttribute("onclick", "chaoxingCheckinLocation(" + JSON.stringify({"active_id": activity["active_id"]}) + "); onclickCooldown(this.id, 5000);");
						button.innerText = ((activity["type"] == "2") ? "Qrcode Checkin" : "Location Checkin") + " (" + activity["name"] + ", " + activity["time_left"] + ")";
						e.appendChild(button);
					}
				}
				if (!Object.keys(activities).length)
					e.innerText = "No ongoing activities.";
			}
			else
				e.style.display = "none";
			listActivity.calling = false;
		}

		/* Video sources control. */
		function setClassroom(url, classroomName_ = "Unknown") {
			let params = new URLSearchParams(decodeURIComponent(new URL(url).search));
			let info = JSON.parse(params.get("info"));
			localStorage.setItem("classroomName", classroomName_);
			localStorage.setItem("classroom", url);
			document.getElementById("xdcheckin-title-div").innerText = "Xdcheckin: " + classroomName_;
			classroom = url;
			classroomName = classroomName_;
			pptVideo = info.videoPath.pptVideo;
			teacherTrack = info.videoPath.teacherTrack;
			teacherFull = info.videoPath.teacherFull;
			studentFull = info.videoPath.studentFull;
		}

		/* Randomize classroom. */
		function randClassroom() {
			let b = Math.floor(Math.random() * buildingsArr.length);
			let c = Math.floor(Math.random() * buildingsArr[b].length);
			return [buildingsArr[b][c], buildingNamesArr[b][c]];
		}

		function reloadClassroom(url, classroomName = "Unknown") {
			setClassroom(url, classroomName);
			player0.loadByUrl(pptVideo);
			player1.loadByUrl(teacherTrack);
			player1.mute();
			player1.stop();
			player2.loadByUrl(teacherFull);
			player2.mute();
			player2.stop();
			player3.loadByUrl(studentFull);
			player3.mute();
			player3.stop();
		}

		async function extractClassroom() {
			let input = prompt("Input liveId or livestream URL:");
			if (input === null)
				return;
			if (input === "") {
				alert("Invalid input.");
				return;
			}
			try {
				let url = new URL(input);
				let params = new URLSearchParams(decodeURIComponent(url.search));
				let liveId = JSON.parse(params.get("liveId"));
			}
			catch (err) {
				if (!input || input.length != 8 || isNaN(input)) {
					alert("Invalid liveId.");
					return;
				}
				liveId = input;
			}
			try {
				let res = await post("/chaoxing/extract_url", data = liveId);
				assert(res.status_code == 200);
				let url = new URL(res.text);
				let info = JSON.parse((new URLSearchParams(decodeURIComponent(url.search))).get("info"));
				assert(!("msg" in info["videoPath"]));
				let info_new = {"videoPath": {}};
				info_new["videoPath"]["teacherFull"] = info["videoPath"]["teacherFull"];
				info_new["videoPath"]["teacherTrack"] = info["videoPath"]["teacherTrack"];
				info_new["videoPath"]["pptVideo"] = info["videoPath"]["pptVideo"];
				info_new["videoPath"]["studentFull"] = info["videoPath"]["studentFull"];
				let url_new = `${url.protocol}//${url.hostname}${url.pathname}` + "?info=" + encodeURIComponent(JSON.stringify(info_new));
				prompt("Extracted URL:", url_new);
			}
			catch (err) {
				alert("Failed to extract URL.")
			}
		}

		function loadExtracted() {
			let input = prompt("Input the extracted URL:");
			if (input === null)
				return;
			if (input === "") {
				alert("Invalid input.");
				return;
			}
			try {
				let url = new URL(input);
			}
			catch (err) {
				alert("Invalid URL.");
				return;
			}
			reloadClassroom(input, "Extracted");
		}

		/* Take screenshot of a player. */
		function screenshot(player) {
			let video = player.tag;
			let canvas = document.createElement('canvas');
			canvas.width = video.videoWidth;
			canvas.height = video.videoHeight;
			let ctx = canvas.getContext("2d");
			ctx.save();
			ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
			let img_src = canvas.toDataURL("image/jpeg", 1.0);
			ctx.restore();
			canvas.remove();
			return img_src;
		}

		/* Qrcode checkin. */
		async function chaoxingCheckinQrcode() {
			location_["ranged"] = 1;
			let res = await post("/chaoxing/checkin_checkin_qrcode_img", data = {"img_src": screenshot(player0), "location": location_});
			if (res.status_code == 200 && res.text.indexOf("success") != -1)
				alert("Checked in successfully.");
			document.getElementById("player0-decodeddata-div").innerText = res.text || "Checkin error:\nBackend error.";
		};

		/* Location checkin. */
		async function chaoxingCheckinLocation(activity) {
			location_["ranged"] = 1;
			let res = await post("/chaoxing/checkin_checkin_location", data = {"activity": activity, "location": location_});
			alert((res.status_code == 200) ? "Checked in successfully." : "Checkin failed.");
		}

		function chaoxingInputAccount() {
			try {
				let username = prompt("Input Chaoxing username:");
				if (username === null)
					return;
				assert(username !== "");
				let password = prompt("Input Chaoxing password");
				if (password === null)
					return;
				assert(/^(((?=.*[0-9])(?=.*[a-zA-Z])|(?=.*[0-9])(?=.*[^\s0-9a-zA-Z])|(?=.*[a-zA-Z])(?=.*[^\s0-9a-zA-Z]))[^\s\u4e00-\u9fa5]+)$/.test(password));
				return [username, password];
			}
			catch (err) {
				alert("Invalid input.");
			}
		}

		/* Log into Chaoxing account. */
		async function chaoxingLogin() {
			if (chaoxingLogin.calling)
				return;
			chaoxingLogin.calling = true;
			[username, password] = [localStorage.getItem("chaoxing_username"), localStorage.getItem("chaoxing_password")];
			if (!username || !password) {
				input = chaoxingInputAccount();
				if (input)
					[username, password] = input;
				else
					return chaoxingLogin.calling = false;
			}
			else if(!confirm("Use previously entered account " + username + "?")) {
				input = chaoxingInputAccount();
				if (input) {
					[username, password] = input;
					localStorage.setItem("chaoxing_cookies", "");
				}
				else
					return chaoxingLogin.calling = false;
			}
			alert("Logging in.");
			try {
				let res = await post("/chaoxing/login", {"username": username, "password": password, "cookies": localStorage.getItem("chaoxing_cookies")});
				assert(chaoxingLogin.done = (res.status_code == 200));
			}
			catch (err) {
				alert("Login failed.");
				return chaoxingLogin.calling = false;
			}
			alert("Logged in successfully.");
			localStorage.setItem("chaoxing_username", username);
			localStorage.setItem("chaoxing_password", password);
			localStorage.setItem("chaoxing_cookies", (await post("/chaoxing/get_cookies")).text);
			localStorage.setItem("chaoxing_fid", (await post("/chaoxing/get_fid")).text);
			enablePlayers();
			courses = (await post("/chaoxing/get_courses")).json();
			curriculum = (await post("/chaoxing/get_curriculum")).json();
			tablifyCurriculum();
			document.getElementById("extract-classroom-button").style.display = "inline";
			document.getElementById("chaoxing-login-button").style.display = "none";
			document.getElementById("chaoxing-curriculum-button").style.display = "block";
			document.getElementById("chaoxing-locations-button").style.display = "block";
			document.getElementById("chaoxing-input-location-button").style.display = "block";
			document.getElementById("chaoxing-activities-button").style.display = "block";
			document.getElementById("player0-scan-button").style.display = "block";
			chaoxingLogin.calling = false;
		}

		async function get(url = "", params = {}) {
			let qstr = new URLSearchParams(params).toString();
			let status_code = 404, text = "";
			try {
				let res = await fetch(qstr ? `${url}?${qstr}` : url);
				[status_code, text] = [res.status, await res.text()];
				
			} catch (err) {}
			return {status_code: status_code, text, json: () => {try {return JSON.parse(text);} catch (err) {return undefined;}}};
		}

		async function post(url = "", data = {}) {
			let status_code = 404, text = "";
			try {
				let res = await fetch(url, {method: "POST", body: JSON.stringify(data)});
				[status_code, text] = [res.status, await res.text()];
			} catch (err) {}
			return {status_code: status_code, text, json: () => {try {return JSON.parse(text);} catch (err) {return undefined;}}};
		}
	</script>
</html>
